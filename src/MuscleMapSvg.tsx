import { useEffect, useRef, type MouseEvent } from 'react'

type MuscleMapSvgProps = {
  workedGroups: Set<string>
  onToggle: (group: string) => void
}

const FRONT_VIEWBOX = '0 0 725 1145'
const BACK_VIEWBOX = '0 0 731 1135'
const FRONT_SVG_URL = `${import.meta.env.BASE_URL}front.svg`
const BACK_SVG_URL = `${import.meta.env.BASE_URL}back.svg`

const CORE_PATH =
  'M15.4683 140.246C18.6929 150.445 25.4683 165.746 25.4683 165.746C25.4683 165.746 30.0065 166.49 33 167.246C39.2734 168.829 43.5381 168.418 50 168.746C58.1905 169.161 62.8214 169.352 71 168.746C78.0775 168.221 88.4683 167.246 88.4683 167.246C88.4683 167.246 94.596 156.249 97.4683 148.746C100.23 141.532 102.246 137.989 102.968 129.746C103.224 126.828 104.468 124.175 104.468 121.246C104.468 118.512 104.785 116.961 104.468 114.246C104.166 111.658 102.968 107.746 102.968 107.746C102.968 107.746 104.959 105.417 105.968 103.746C107.599 101.045 108.281 99.3245 108.968 96.2458C109.905 92.0534 110.317 89.3242 108.968 85.2458C108.2 82.923 107.355 81.7618 105.968 79.7458C105.415 78.9414 104.468 77.7458 104.468 77.7458C104.468 77.7458 108.146 72.9107 108.968 69.2458C109.652 66.1974 109.399 64.3402 108.968 61.2458C108.635 58.8536 108.415 57.4676 107.468 55.2458C106.257 52.4058 102.968 48.7458 102.968 48.7458C102.968 48.7458 104.862 47.2951 105.968 46.2458C109.428 42.9661 111.014 40.5939 112.968 36.2458C114.387 33.0899 114.922 31.1625 115.468 27.7458C116.146 23.504 116.773 20.8386 115.468 16.7458C114.805 14.6659 112.968 11.7458 112.968 11.7458C112.968 11.7458 106.889 12.5788 102.968 12.7458C96.1291 13.0373 92.2646 12.5633 85.4683 11.7458C78.168 10.8678 73.487 11.6473 66.9683 8.24585C62.7777 6.05919 57.4683 0.74585 57.4683 0.74585C57.4683 0.74585 53.1517 6.06146 49.4683 8.24585C44.4578 11.2172 40.7248 10.854 34.9683 11.7458C30.8978 12.3765 28.5864 12.6593 24.4683 12.7458C19.1829 12.8569 16.2064 12.4598 10.9683 11.7458C7.62839 11.2906 2.46826 10.2458 2.46826 10.2458C2.46826 10.2458 1.29773 15.3912 0.968261 18.7458C0.548376 23.021 0.167815 25.5253 0.968261 29.7458C1.54354 32.7791 2.14394 34.4569 3.46826 37.2458C4.86226 40.1815 5.73256 41.8873 7.96826 44.2458C9.98321 46.3716 13.9683 48.7458 13.9683 48.7458C13.9683 48.7458 8.43561 54.5412 6.96826 59.2458C6.08847 62.0667 5.96826 66.7458 5.96826 66.7458C5.96826 66.7458 6.08961 70.5389 6.96826 72.7458C8.05164 75.4671 11.4683 78.7458 11.4683 78.7458C11.4683 78.7458 8.67863 82.4517 7.96826 85.2458C7.24658 88.0845 7.96826 92.7458 7.96826 92.7458C7.96826 92.7458 7.83065 98.5889 9.96826 101.246C11.1923 102.767 13.9683 104.246 13.9683 104.246C13.9683 104.246 12.0997 108.724 11.4683 111.746M15.4683 140.246C13.6975 134.645 12.2282 131.571 11.4683 125.746M15.4683 140.246L11.4683 125.746M11.4683 125.746C10.761 120.324 10.35 117.098 11.4683 111.746M11.4683 125.746V111.746'
const CORE_VIEWBOX = '0 0 117 170'
const CORE_TRANSFORM = 'translate(285 322) scale(1.3)'

const CHEST_PATH =
  'M140.788 34.9329C140.788 34.9329 139.874 33.5186 139.288 32.9329C137.14 30.785 132.788 27.9329 132.788 27.9329C132.788 27.9329 129.622 25.6232 127.288 24.4329C123.553 22.528 121.625 21.1214 117.788 19.4329C112.701 17.1946 109.69 16.2393 104.288 14.9329C99.6703 13.816 97.002 13.5248 92.2881 12.9329C87.8152 12.3712 85.296 11.9463 80.7881 11.9329C77.4629 11.9229 72.2881 12.4329 72.2881 12.4329C72.2881 12.4329 66.1417 13.4274 62.2881 14.4329C57.0897 15.7891 54.574 17.9732 49.2881 18.9329C44.4812 19.8056 41.6729 19.3567 36.7881 19.4329C33.6643 19.4816 29.3311 19.0965 27.7881 18.4329C26.245 17.7692 26.6286 17.945 25.2881 16.9329C22.8539 15.095 21.6312 13.8855 19.2881 11.9329C16.9449 9.98024 15.7207 8.77284 13.2881 6.93286C11.3871 5.49502 10.446 4.44492 8.28809 3.43286C6.44239 2.56725 1.28809 0.932861 1.28809 0.932861C1.28809 0.932861 6.68978 8.43628 9.28809 12.4329C14.0538 19.7632 16.6529 23.7292 20.7881 31.4329C23.8033 37.05 25.7913 40.3059 28.7881 45.9329C34.0481 55.8092 36.7949 61.4834 42.7881 70.9329C46.8493 77.3362 48.5241 81.5337 53.2881 87.4329C56.4158 91.3059 58.4773 93.2296 62.2881 96.4329C67.1084 100.485 70.411 102.172 76.2881 104.433C84.2277 107.487 89.2881 107.933 96.2881 107.933C103.288 107.933 116.379 108.872 120.788 107.933C125.197 106.994 127.791 106.517 131.788 104.433C134.285 103.131 135.803 102.431 137.788 100.433C139.164 99.0477 140.788 95.9329 140.788 95.9329M140.788 34.9329L146.288 29.9329C146.288 29.9329 151.015 26.3469 154.288 24.4329C158.738 21.8303 166.288 18.9329 166.288 18.9329C166.288 18.9329 175.347 16.1384 181.288 14.9329C186.511 13.8731 189.489 13.507 194.788 12.9329C201.206 12.2374 204.25 11.9603 210.288 12.4329C217.657 13.0096 221.882 14.9821 228.788 16.4329C234.411 17.6142 237.55 18.6328 243.288 18.9329C245.823 19.0654 247.262 19.1874 249.788 18.9329C252.57 18.6525 254.118 18.2605 256.788 17.4329C259.459 16.6052 262.126 15.0482 267.788 10.9329C269.589 9.62391 276.788 4.93286 276.788 4.93286C276.788 4.93286 261.468 30.6179 252.288 47.4329C246.261 58.4722 243.948 65.0925 236.788 75.4329C232.048 82.2777 229.618 86.4888 223.788 92.4329C219.916 96.3808 218.026 99.0818 213.288 101.933C209.156 104.419 206.463 105.249 201.788 106.433C196.646 107.735 193.583 107.616 188.288 107.933C182.051 108.307 178.53 108.224 172.288 107.933C166.019 107.64 162.327 108.141 156.288 106.433C151.995 105.218 149.299 104.685 145.788 101.933C143.504 100.142 140.788 95.9329 140.788 95.9329M140.788 34.9329V95.9329'
const CHEST_VIEWBOX = '0 0 278 109'
const CHEST_TRANSFORM = 'translate(177 194) scale(1.32)'

const BICEPS_PATH_LEFT =
  'M10.6523 13.6732C7.24959 16.0988 1.15234 20.6732 1.15234 20.6732C1.15234 20.6732 4.02264 21.3583 4.65234 21.6732C5.65234 22.1732 5.71494 22.1968 6.65234 22.6732C8.63706 23.6819 8.91459 24.2815 10.6523 25.6732C13.0331 27.5798 14.2045 28.8535 16.6523 30.6732C18.9124 32.3532 20.1827 33.32 22.6523 34.6732C25.8006 36.3982 27.8329 36.8064 31.1523 38.1732C34.4718 39.54 36.2518 40.5229 39.6523 41.6732C43.2864 42.9024 45.3773 43.4906 49.1523 44.1732C53.397 44.9407 55.8397 45.0897 60.1523 45.1732C65.6326 45.2793 68.7604 45.1587 74.1523 44.1732C77.9261 43.4834 79.9596 42.7129 83.6523 41.6732C88.1711 40.4009 95.1523 38.1732 95.1523 38.1732C95.1523 38.1732 93.9989 35.4 93.1523 33.6732C90.6011 28.4692 88.8051 25.6729 85.1523 21.1732C83.4967 19.1336 82.476 18.0641 80.6523 16.1732C77.8711 13.2894 76.274 11.6845 73.1523 9.17319C71.083 7.50844 69.9699 6.47023 67.6523 5.17319C63.7185 2.97163 61.0732 2.55531 56.6523 1.67319C52.4222 0.829131 49.9632 0.824828 45.6523 0.673191C42.9204 0.577091 41.3652 0.336342 38.6523 0.673191C35.6442 1.04671 34.0476 1.77538 31.1523 2.67319C27.376 3.84422 25.1198 4.27355 21.6523 6.17319C19.3724 7.42222 18.3002 8.45872 16.1523 9.92319C14.0045 11.3877 12.7692 12.1642 10.6523 13.6732Z'
const BICEPS_PATH_RIGHT =
  'M349.652 28.6732C347.558 32.3052 344.652 38.1732 344.652 38.1732C344.652 38.1732 348.612 39.0961 351.152 39.6732C354.663 40.4708 356.624 40.9539 360.152 41.6732C364.431 42.5455 366.826 43.0856 371.152 43.6732C375.427 44.2537 377.839 44.6142 382.152 44.6732C385.867 44.7241 387.99 44.799 391.652 44.1732C394.033 43.7664 395.328 43.3295 397.652 42.6732C402.228 41.3811 404.81 40.6111 409.152 38.6732C412.582 37.1425 414.313 35.8927 417.652 34.1732C421.146 32.3742 423.23 31.6042 426.652 29.6732C429.248 28.2086 430.619 27.2432 433.152 25.6732C436.284 23.7326 441.152 20.6732 441.152 20.6732C441.152 20.6732 438.668 19.8698 437.152 19.1732C434.199 17.8162 432.843 16.4958 430.152 14.6732C427.371 12.7891 426.047 11.378 423.152 9.6732C420.895 8.34379 419.527 7.77987 417.152 6.6732C414.457 5.41682 412.964 4.64208 410.152 3.67321C405.987 2.2381 403.532 1.64682 399.152 1.17321C395.076 0.732363 392.673 0.366568 388.652 1.17321C385.381 1.82958 383.712 2.84138 380.652 4.17321C376.408 6.02087 370.152 9.6732 370.152 9.6732C370.152 9.6732 365.135 12.1846 362.152 14.1732C359.488 15.9499 357.098 17.6732 355.652 19.1732C352.607 22.3327 351.844 24.8718 349.652 28.6732Z'
const BICEPS_VIEWBOX = '0 0 443 46'
const BICEPS_TRANSFORM = 'translate(70 175) scale(1.33)'

const TRICEPS_PATH_LEFT =
  'M124.873 24.5571C129.083 24.3438 136.373 23.0571 136.373 23.0571C136.373 23.0571 129.269 27.0941 124.873 29.5571C119.907 32.3397 116.28 33.2771 110.873 35.0571C101.416 38.1704 88.373 40.0571 82.873 40.0571C77.373 40.0571 65.373 39.0571 54.873 37.0571C46.9644 35.5507 43.2243 33.8397 35.873 30.5571L35.5418 30.4092C29.4461 27.6874 25.9234 26.1145 19.873 23.0571C13.3221 19.7467 1.87305 12.5571 1.87305 12.5571C1.87305 12.5571 12.873 13.0571 20.373 11.0571C23.7322 10.1614 28.373 6.05713 28.373 6.05713C28.373 6.05713 33.6766 5.50654 36.373 5.05713C42.373 4.05713 49.873 0.557129 49.873 0.557129C49.873 0.557129 54.6252 3.01771 57.873 4.05713C63.3173 5.79946 66.6728 5.63082 72.373 6.05713C79.1882 6.56681 87.873 6.55713 87.873 6.55713C87.873 6.55713 93.3968 12.3142 98.873 16.0571C102.553 18.5721 108.198 21.4961 112.373 23.0571C115.047 24.0571 121.373 24.7345 124.873 24.5571Z'
const TRICEPS_PATH_RIGHT =
  'M357.873 24.5571C354.938 24.5642 347.873 23.5571 347.873 23.5571C347.873 23.5571 352.597 26.8707 355.873 28.5571C358.787 30.0571 361.922 31.114 365.873 32.5571C373.532 35.3549 377.852 37.0895 385.873 38.5571C393.578 39.9668 397.541 40.0571 405.373 40.0571C413.205 40.0571 417.157 39.9044 424.873 38.5571C431.638 37.3759 434.891 36.8252 441.373 34.5571C447.399 32.4487 450.642 30.3698 456.373 27.5571C462.179 24.7079 466.341 21.907 471.873 18.5571C476.459 15.7799 483.373 12.5571 483.373 12.5571H478.373C474.858 12.5571 471.632 12.6546 467.373 12.0571C462.589 11.386 460.697 10.906 455.373 9.05713C451.159 7.59356 448.939 6.3928 444.873 4.55713C441.529 3.04758 436.373 0.557129 436.373 0.557129C436.373 0.557129 430.764 2.28689 426.373 3.55713C421.958 4.8343 417.934 5.99143 413.373 6.55713C407.172 7.32623 395.873 6.55713 395.873 6.55713C395.873 6.55713 389.615 14.2323 382.873 18.0571C379.528 19.9549 376.054 21.443 372.373 22.5571C368.692 23.6712 363.589 24.5433 357.873 24.5571Z'
const TRICEPS_VIEWBOX = '0 0 484 41'
const TRICEPS_TRANSFORM = 'translate(40 237) scale(1.33)'

const applyWorkedClasses = (root: HTMLElement | null, workedGroups: Set<string>) => {
  if (!root) return
  const regions = root.querySelectorAll<HTMLElement>('[data-group]')
  regions.forEach((region) => {
    const group = region.getAttribute('data-group')
    if (!group) return
    if (workedGroups.has(group)) {
      region.classList.add('worked')
    } else {
      region.classList.remove('worked')
    }
  })
}

export default function MuscleMapSvg({ workedGroups, onToggle }: MuscleMapSvgProps) {
  const frontRef = useRef<HTMLDivElement>(null)
  const backRef = useRef<HTMLDivElement>(null)

  useEffect(() => {
    applyWorkedClasses(frontRef.current, workedGroups)
    applyWorkedClasses(backRef.current, workedGroups)
  }, [workedGroups])

  const handleClick = (event: MouseEvent<HTMLDivElement>) => {
    const target = event.target as Element | null
    if (!target) return
    const region = target.closest('[data-group]')
    if (!region) return
    const group = region.getAttribute('data-group')
    if (group) {
      onToggle(group)
    }
  }

  return (
    <div className="muscle-map-grid">
      <div className="map-panel">
        <p className="map-title">Front</p>
        <div
          ref={frontRef}
          className="muscle-svg-frame"
          role="img"
          aria-label="Front body map"
          onClick={handleClick}
        >
          <svg className="muscle-map" viewBox={FRONT_VIEWBOX} aria-hidden="true">
            <image
              href={FRONT_SVG_URL}
              x="0"
              y="0"
              width="725"
              height="1145"
              className="muscle-image"
              preserveAspectRatio="xMidYMid meet"
            />
            <g className="muscle-region" data-group="Chest" transform={CHEST_TRANSFORM}>
              <path d={CHEST_PATH} />
            </g>
            <g className="muscle-region" data-group="Biceps" transform={BICEPS_TRANSFORM}>
              <path d={BICEPS_PATH_LEFT} />
              <path d={BICEPS_PATH_RIGHT} />
            </g>
            <g className="muscle-region" data-group="Triceps" transform={TRICEPS_TRANSFORM}>
              <path d={TRICEPS_PATH_LEFT} />
              <path d={TRICEPS_PATH_RIGHT} />
            </g>
            <g className="muscle-region" data-group="Core" transform={CORE_TRANSFORM}>
              <path d={CORE_PATH} />
            </g>
          </svg>
        </div>
      </div>

      <div className="map-panel">
        <p className="map-title">Back</p>
        <div
          ref={backRef}
          className="muscle-svg-frame"
          role="img"
          aria-label="Back body map"
          onClick={handleClick}
        >
          <svg className="muscle-map" viewBox={BACK_VIEWBOX} aria-hidden="true">
            <image
              href={BACK_SVG_URL}
              x="0"
              y="0"
              width="731"
              height="1135"
              className="muscle-image"
              preserveAspectRatio="xMidYMid meet"
            />
          </svg>
        </div>
      </div>
    </div>
  )
}
